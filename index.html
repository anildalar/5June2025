<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Document</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    </head>
    <body>
        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row mt-5">
                <div class="col-8 offset-2">
                    <form>
                        <input autofocus type="text" name="car_name" class="form-control form-control-lg mb-4" placeholder="Enter your Car Name" />
                        <div class="d-grid">
                            <input type="submit" value="Save" class="btn btn-primary btn-lg" onclick="sendData(event)" />
                        </div>
                    </form >
                </div>
            </div>
            <div class="row mt-5">
                <div class="col-8 offset-2 mytablecol">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>     
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script> 
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
            let base_url = 'http://localhost:1337';
            //Global Variable
            //let ceo1 = new ClassName();
            var xhr = new XMLHttpRequest(); 
            //1. Function defination
            function sendData(e){ // e is a formal argument
               
                //If any variable defined inside function
                // Local Variable
                
                //object.method();
                e.preventDefault(); // To stop page reloading
                console.log('I am inside anil function');
                //I want to access form data here..
                //On which element this event is happening ?
                //Traversing Up
                console.log(e.target.closest('form'));

                //Traversing Down
                console.log(e.target.closest('form').querySelector('input:first-child').value);
                var cname = e.target.closest('form').querySelector('input:first-child').value;


                
                xhr.onreadystatechange = function() {
                    
                    if (this.readyState == 4 && this.status == 201) {
                        //alert("Car Saved Successfully");
                        Swal.fire({
                            title: "Car Saved Successfully!",
                            icon: "success",
                            draggable: true
                        }).then(() => {
                            //Page Reload
                            //object.method();
                           location.reload();
                        });
                       
                    }
                    /*
                    1.
                    if (this.readyState == 4 && this.status == 201) {
                        alert("Car Saved Successfully");
                    }
                    2.
                    if (true && true) {
                        alert("Car Saved Successfully");
                    }
                    3.
                    if (true) {
                        alert("Car Saved Successfully");
                    }
                    */
                };   
                //I am setting the Headers
                xhr.open("POST", `${base_url}/api/cars`, true);

                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.setRequestHeader("Accept", "application/json"); 

                //object.member
                //1. object.property
                //2. object.method(aa1,aa2); //camleCase
               
                // Optional: If authentication is required
                // xhr.setRequestHeader("Authorization", "Bearer YOUR_JWT_TOKEN");
                const data = {
                    data: {
                        car_name: cname,
                    }
                };
                xhr.send(JSON.stringify(data));

            }
        </script>
        <script>
            //  Read Operation with AJAX i.e XMLHttpRequest Class
            // Can i access xhr object here...
            //xhr.setRequestHeader()
            xhr.open('GET',`${base_url}/api/cars`,true);

            //CBFN
            xhr.onreadystatechange = function(){
                //To get data 

                //1. Server Status code should be 200
                //2. xhr.readyStatus should be 4
                if (this.readyState == 4 && this.status == 200) {
                    console.log(this.responseText);
                    console.log(JSON.parse(this.responseText));

                    var json = JSON.parse(this.responseText);

                    console.log(json.data);

                    //I want to loop over Array of object
                    // []

                    var mytcol = document.querySelector('.mytablecol');
                    console.log(mytcol);
                    mytcol.innerHTML = ``;
                    mytcol.innerHTML = `<table class="table table-success" id="mytable">
                                        <thead>
                                            <tr>
                                                <th>Car Name</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                    var tbody = document.getElementById('mytable').querySelector('tbody');
                    console.log(tbody);

                    tbody.innerHTML = '' ;
                    // [{},{},{}]
                    for (variable of json.data) {
                        // code block to be executed
                        console.log(variable.car_name);
                         tbody.innerHTML += `
                            <tr>
                                <td>${variable.car_name}</td>
                                <td>
                                    <button  class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#exampleModal">View</button>
                                    <button class="btn btn-sm btn-info">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteElement(this)" data-delid=${variable.documentId}>Delete</button>
                                </td>
                            </tr>
                         `;
                        
                        //Get 
                    }
                    //mytcol.innerHTML = mytcol.innerHTML +  tbody.innerHTML;

                    mytcol.innerHTML = mytcol.innerHTML + `
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th></th>
                                </tr>
                            </tfoot> 
                        </table>
                    `;

                }

            }
            xhr.send();
            //IIFE (cbfn)();
            (()=>{
                console.log('OK');
            })();

            //1. Function defination is one time process
            function deleteElement(e){ // e is a formal argument e = event
                // console.log(e.closest('tr'));
                console.log(e);
                const delId = e.dataset.delid; // access data-delid attribute
                console.log("Delete ID:", delId);
                //use xhr
                
                console.log('I am inside deleteElement function');
                Swal.fire({
                    title: "Are you sure?",
                    text: "You won't be able to revert this!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Yes, delete it!"
                }).then((result) => {
                    if (result.isConfirmed) {
                        
                        xhr.open('DELETE',`${base_url}/api/cars/${delId}`);
                        
                        xhr.send();
                        
                        e.closest('tr').remove();
                        console.log('File delete successfully');
                        // lets remove the element
                        // 1.
                        Swal.fire({
                            title: "Deleted!",
                            text: "Your file has been deleted.",
                            icon: "success"
                        });
                    }
                });
            }
        </script>
    </body>
</html>